# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift
name: CI - Aura

on:

  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'Aura/**'
      - '.github/workflows/ci-aura.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest

    env:
      PROJECT_PATH: Aura/Aura.xcodeproj
      SCHEME: Aura
      DESTINATION: 'platform=iOS Simulator,name=iPhone 15'
      DERIVED_DATA: ${{ github.workspace }}/DerivedData

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Optionnel) fixe la version de Xcode si tu veux être explicite
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16' # adapte si besoin (ou supprime ce step)

      # Cache Swift Package Manager
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/SourcePackages
            ~/.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # (Optionnel) Cache DerivedData pour accélérer les builds incrémentaux
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ${{ env.DERIVED_DATA }}
          key: ${{ runner.os }}-deriveddata-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: List available simulators (debug aid)
        run: xcrun simctl list --json devices

      - name: Build (Aura)
        run: |
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -configuration Debug \
            -derivedDataPath "$DERIVED_DATA" \
            -allowProvisioningUpdates \
            -skipPackagePluginValidation \
            clean build

      - name: Test (Aura)
        run: |
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -configuration Debug \
            -derivedDataPath "$DERIVED_DATA" \
            -allowProvisioningUpdates \
            -skipPackagePluginValidation \
            -resultBundlePath TestResults.xcresult \
            test

      - name: Upload test results (.xcresult)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Aura-xcresult
          path: TestResults.xcresult

      - name: Convert test results to JUnit (for PR annotations)
        if: always()
        run: |
          xcrun xcresulttool get --format json --path TestResults.xcresult > results.json
          # Astuce: ajoute un parseur si tu veux publier du JUnit (ex: xcparse, xcbeautify-junit, etc.)

